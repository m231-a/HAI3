name: AI Guidelines Validation

on:
  push:
    branches: [ main ]
    paths:
      - '.ai/**'
      - '.claude/**'
      - 'packages/**/CLAUDE.md'
      - 'packages/**/llms.txt'
      - 'packages/**/commands/**'
  pull_request:
    branches: [ main ]
    paths:
      - '.ai/**'
      - '.claude/**'
      - 'packages/**/CLAUDE.md'
      - 'packages/**/llms.txt'
      - 'packages/**/commands/**'

jobs:
  validate-ai-files:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '25.x'
        cache: 'npm'

    - name: Validate GUIDELINES.md exists
      run: |
        if [ ! -f ".ai/GUIDELINES.md" ]; then
          echo "ERROR: .ai/GUIDELINES.md is missing"
          exit 1
        fi
        echo "GUIDELINES.md found"

    - name: Validate SDK package documentation
      run: |
        SDK_PACKAGES="events store layout api i18n framework react"
        MISSING=""

        for pkg in $SDK_PACKAGES; do
          if [ ! -f "packages/$pkg/CLAUDE.md" ]; then
            MISSING="$MISSING packages/$pkg/CLAUDE.md"
          fi
          if [ ! -f "packages/$pkg/llms.txt" ]; then
            MISSING="$MISSING packages/$pkg/llms.txt"
          fi
        done

        if [ -n "$MISSING" ]; then
          echo "ERROR: Missing documentation files:$MISSING"
          exit 1
        fi
        echo "All SDK package documentation files present"

    - name: Validate command naming conventions
      run: |
        # Check hai3-* commands follow naming convention
        INVALID=""

        for cmd in packages/*/commands/*.md; do
          if [ -f "$cmd" ]; then
            filename=$(basename "$cmd")
            if [[ ! "$filename" =~ ^hai3-.+\.md$ ]] && [[ ! "$filename" =~ ^hai3dev-.+\.md$ ]]; then
              INVALID="$INVALID $cmd"
            fi
          fi
        done

        for cmd in .ai/commands/*.md .ai/commands/user/*.md; do
          if [ -f "$cmd" ]; then
            filename=$(basename "$cmd")
            if [[ ! "$filename" =~ ^hai3-.+\.md$ ]] && [[ ! "$filename" =~ ^hai3dev-.+\.md$ ]]; then
              INVALID="$INVALID $cmd"
            fi
          fi
        done

        if [ -n "$INVALID" ]; then
          echo "ERROR: Commands with invalid naming:$INVALID"
          echo "Commands must start with 'hai3-' or 'hai3dev-'"
          exit 1
        fi
        echo "All commands follow naming conventions"

    - name: Validate target files exist
      run: |
        REQUIRED_TARGETS="EVENTS STORE LAYOUT API I18N FRAMEWORK REACT"
        MISSING=""

        for target in $REQUIRED_TARGETS; do
          if [ ! -f ".ai/targets/$target.md" ]; then
            MISSING="$MISSING .ai/targets/$target.md"
          fi
        done

        if [ -n "$MISSING" ]; then
          echo "ERROR: Missing target files:$MISSING"
          exit 1
        fi
        echo "All SDK target files present"

    - name: Validate routing table in GUIDELINES.md
      run: |
        # Check that GUIDELINES.md contains routing entries for all SDK packages
        GUIDELINES=".ai/GUIDELINES.md"
        PACKAGES="packages/events packages/store packages/layout packages/api packages/i18n packages/framework packages/react"
        MISSING=""

        for pkg in $PACKAGES; do
          if ! grep -q "$pkg" "$GUIDELINES"; then
            MISSING="$MISSING $pkg"
          fi
        done

        if [ -n "$MISSING" ]; then
          echo "ERROR: Missing routing entries in GUIDELINES.md:$MISSING"
          exit 1
        fi
        echo "All SDK packages have routing entries"

    - name: Check package.json files array
      run: |
        SDK_PACKAGES="events store layout api i18n framework react"
        ISSUES=""

        for pkg in $SDK_PACKAGES; do
          if ! grep -q '"llms.txt"' "packages/$pkg/package.json"; then
            ISSUES="$ISSUES packages/$pkg/package.json (missing llms.txt)"
          fi
          if ! grep -q '"CLAUDE.md"' "packages/$pkg/package.json"; then
            ISSUES="$ISSUES packages/$pkg/package.json (missing CLAUDE.md)"
          fi
        done

        if [ -n "$ISSUES" ]; then
          echo "ERROR: Package files array issues:$ISSUES"
          exit 1
        fi
        echo "All packages include AI documentation in files array"

  # Optional: Run promptfoo tests if configured
  promptfoo-tests:
    runs-on: ubuntu-latest
    if: ${{ hashFiles('promptfoo.yaml') != '' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '25.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install promptfoo
      run: npm install -g promptfoo

    - name: Run promptfoo tests
      run: promptfoo eval
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
